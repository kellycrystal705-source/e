name: Build Floppy Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses-dev bison flex \
            libssl-dev libelf-dev bc xz-utils wget \
            gcc-multilib syslinux mtools dosfstools

      - name: Download kernel 6.6 LTS
        run: |
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.tar.xz
          tar -xf linux-6.6.tar.xz
          rm linux-6.6.tar.xz

      - name: Patch kernel source to remove large static tables
        run: |
          cd linux-6.6

          # Remove Intel early CPU ID table (saves ~13KB)
          sed -i 's/static const struct x86_cpu_id intel_early_ids\[\]/static const struct x86_cpu_id intel_early_ids[] __attribute__((unused))/' arch/x86/kernel/cpu/match.c 2>/dev/null || true

          # Remove efifb DMI table (saves ~13KB) - not needed for BIOS boot
          sed -i '/efifb_dmi_system_table/,/^};/{s/^/\/\//}' drivers/video/fbdev/efifb.c 2>/dev/null || true

          # Remove reboot DMI table entries (saves ~13KB)
          sed -i 's/static struct dmi_system_id reboot_dmi_table/static struct dmi_system_id reboot_dmi_table[] __attribute__((unused)); static struct dmi_system_id reboot_dmi_table_unused/' arch/x86/kernel/reboot.c 2>/dev/null || true

          # Remove panel orientation quirks table (saves ~13KB)
          # Already disabled via DRM=n but double check
          echo "Source patches applied"

      - name: Build 32-bit config
        run: |
          cd linux-6.6
          make ARCH=i386 allnoconfig
          ./scripts/kconfig/merge_config.sh -m .config ../kernel.fragment
          make ARCH=i386 olddefconfig

      - name: Force-remove unwanted options
        run: |
          cd linux-6.6
          force_off() {
            sed -i "s/^CONFIG_${1}=.*$/# CONFIG_${1} is not set/" .config
          }
          force_off KALLSYMS
          force_off PERF_EVENTS
          force_off BUG
          force_off ELF_CORE
          force_off COREDUMP
          force_off SLUB_DEBUG
          force_off DEBUG_MEMORY_INIT
          force_off DEBUG_BUGVERBOSE
          force_off STACKTRACE
          force_off STACKDEPOT
          force_off FRAME_POINTER
          force_off IO_URING
          force_off AIO
          force_off SGETMASK_SYSCALL
          force_off SYSFS_SYSCALL
          force_off FHANDLE
          force_off ADVISE_SYSCALLS
          force_off MEMBARRIER
          force_off RSEQ
          force_off CACHESTAT_SYSCALL
          force_off NAMESPACES
          force_off MEMFD_CREATE
          force_off SECRETMEM
          force_off MODIFY_LDT_SYSCALL
          force_off CPU_SUP_INTEL
          force_off CPU_SUP_HYGON
          force_off CPU_SUP_CENTAUR
          force_off CPU_SUP_ZHAOXIN
          force_off X86_INTEL_PSTATE
          force_off PERF_EVENTS_INTEL_UNCORE
          force_off PERF_EVENTS_INTEL_RAPL
          force_off PERF_EVENTS_INTEL_CSTATE
          force_off X86_PKG_TEMP_THERMAL
          force_off INTEL_TCC
          force_off ACPI_CPPC_LIB
          force_off ACPI_HOTPLUG_CPU
          force_off ACPI_CONTAINER
          force_off ACPI_HOTPLUG_IOAPIC
          force_off ACPI_TABLE_UPGRADE
          force_off ACPI_PRMT
          force_off ACPI_PCC
          force_off ACPI_LPIT
          force_off ACPI_AC
          force_off ACPI_BATTERY
          force_off ACPI_FAN
          force_off ACPI_SLEEP
          force_off MAILBOX
          force_off PCC
          force_off SERIO
          force_off SERIO_I8042
          force_off SERIO_LIBPS2
          force_off KEYBOARD_ATKBD
          force_off INPUT_VIVALDIFMAP
          force_off SCSI
          force_off SCSI_MOD
          force_off PNP
          force_off PNPACPI
          force_off THERMAL
          force_off PINCTRL
          force_off VGA_ARB
          force_off VGA_CONSOLE
          force_off FONT_8x8
          force_off FW_LOADER
          force_off VM_EVENT_COUNTERS
          force_off HOTPLUG_CPU
          force_off HOTPLUG_SMT
          force_off EFI_ESRT
          force_off DRM_PANEL_ORIENTATION_QUIRKS
          force_off PCI_QUIRKS
          force_off XZ_DEC_POWERPC
          force_off XZ_DEC_IA64
          force_off XZ_DEC_ARM
          force_off XZ_DEC_ARMTHUMB
          force_off XZ_DEC_SPARC
          force_off CRYPTO_LIB_BLAKE2S_GENERIC
          force_off SHMEM
          force_off RANDOMIZE_KSTACK_OFFSET
          force_off GENERIC_CPU_VULNERABILITIES
          echo "Force-off complete"

      - name: Build 32-bit kernel
        run: |
          cd linux-6.6
          make ARCH=i386 -j$(nproc) bzImage 2>&1 | tail -20
          ls -lh arch/x86/boot/bzImage
          du -k arch/x86/boot/bzImage | awk '{print "Kernel: "$1" KB / 1440 KB"}'

      - name: Bloat report
        run: |
          cd linux-6.6
          echo "=== Top 40 largest symbols ==="
          nm --size-sort -r vmlinux | awk '{print $1, $3}' | head -40
          size vmlinux

      - name: Build minimal initramfs
        run: |
          # Get static busybox from apt (reliable, no download issues)
          sudo apt-get install -y busybox-static
          cp $(which busybox) ./busybox
          chmod +x busybox

          # Build initramfs directory structure
          mkdir -p initramfs/{bin,dev,proc,sys,tmp}
          cp busybox initramfs/bin/busybox

          # Install busybox applets
          cd initramfs/bin
          for cmd in sh ls cat echo mkdir mount umount; do
            ln -s busybox $cmd
          done
          cd ../..

          # Create init script
          cat > initramfs/init << 'EOF'
          #!/bin/sh
          mount -t proc none /proc
          mount -t sysfs none /sys
          mount -t devtmpfs none /dev

          # Set CPU to powersave low frequency
          for cpu in /sys/devices/system/cpu/cpu*/cpufreq; do
            echo powersave > $cpu/scaling_governor 2>/dev/null
            echo 400000 > $cpu/scaling_max_freq 2>/dev/null
          done

          echo "Welcome to FloppyOS"
          exec /bin/sh
          EOF
          chmod +x initramfs/init

          # Pack initramfs
          cd initramfs
          find . | cpio -H newc -o | xz --check=crc32 -9e > ../initramfs.xz
          cd ..

          ls -lh initramfs.xz
          du -k initramfs.xz | awk '{print "Initramfs: "$1" KB"}'

      - name: Clean build artifacts to free disk
        run: |
          # Keep only the kernel binary, remove 15GB of build files
          cp linux-6.6/arch/x86/boot/bzImage ./vmlinuz
          rm -rf linux-6.6
          df -h

      - name: Build floppy image
        run: |
          KERNEL_KB=$(du -k vmlinuz | cut -f1)
          INITRD_KB=$(du -k initramfs.xz | cut -f1)
          TOTAL=$((KERNEL_KB + INITRD_KB))
          echo "Kernel: ${KERNEL_KB}KB  Initramfs: ${INITRD_KB}KB  Total: ${TOTAL}KB / 1440KB"

          if [ $TOTAL -gt 1300 ]; then
            echo "WARNING: Too big to fit on floppy with syslinux overhead!"
          fi

          # Create 1.44MB floppy image
          dd if=/dev/zero of=floppy.img bs=1024 count=1440
          mkfs.fat -F 12 -n "FLOPPYOS" floppy.img
          syslinux --install floppy.img

          # Copy files
          mcopy -i floppy.img vmlinuz ::vmlinuz
          mcopy -i floppy.img initramfs.xz ::initrd.xz

          # Syslinux config
          cat > syslinux.cfg << 'EOF'
          DEFAULT linux
          PROMPT 0
          TIMEOUT 10
          LABEL linux
            KERNEL vmlinuz
            INITRD initrd.xz
            APPEND quiet
          EOF
          mcopy -i floppy.img syslinux.cfg ::syslinux.cfg

          echo "=== Floppy contents ==="
          mdir -i floppy.img

      - name: Upload floppy image
        uses: actions/upload-artifact@v4
        with:
          name: floppy
          path: floppy.img

      - name: Upload kernel
        uses: actions/upload-artifact@v4
        with:
          name: vmlinuz-32bit
          path: vmlinuz
          retention-days: 30
