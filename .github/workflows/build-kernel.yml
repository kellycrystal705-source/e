name: Build Minimal Kernel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses-dev bison flex \
            libssl-dev libelf-dev bc xz-utils wget

      - name: Download kernel 6.6 LTS
        run: |
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.tar.xz
          tar -xf linux-6.6.tar.xz
          rm linux-6.6.tar.xz

      - name: Build config
        run: |
          cd linux-6.6
          make allnoconfig
          ./scripts/kconfig/merge_config.sh .config ../kernel.fragment
          make olddefconfig

      - name: Force-remove unwanted options with sed
        run: |
          cd linux-6.6
          force_off() {
            local opt=$1
            sed -i "s/^CONFIG_${opt}=.*$/# CONFIG_${opt} is not set/" .config
          }

          # Debug/trace bloat
          force_off KALLSYMS
          force_off PERF_EVENTS
          force_off BUG
          force_off ELF_CORE
          force_off COREDUMP
          force_off SLUB_DEBUG
          force_off DEBUG_MEMORY_INIT
          force_off DEBUG_BUGVERBOSE
          force_off STACKTRACE
          force_off STACKDEPOT
          force_off FRAME_POINTER

          # Unneeded syscalls
          force_off IO_URING
          force_off AIO
          force_off SGETMASK_SYSCALL
          force_off SYSFS_SYSCALL
          force_off FHANDLE
          force_off ADVISE_SYSCALLS
          force_off MEMBARRIER
          force_off RSEQ
          force_off CACHESTAT_SYSCALL
          force_off NAMESPACES
          force_off MEMFD_CREATE
          force_off SECRETMEM
          force_off MODIFY_LDT_SYSCALL

          # Wrong CPU vendors
          force_off CPU_SUP_INTEL
          force_off CPU_SUP_HYGON
          force_off CPU_SUP_CENTAUR
          force_off CPU_SUP_ZHAOXIN
          force_off X86_INTEL_MEMORY_PROTECTION_KEYS
          force_off X86_INTEL_TSX_MODE_OFF
          force_off X86_VMX_FEATURE_NAMES
          force_off IA32_FEAT_CTL
          force_off X86_5LEVEL
          force_off PERF_EVENTS_INTEL_UNCORE
          force_off PERF_EVENTS_INTEL_RAPL
          force_off PERF_EVENTS_INTEL_CSTATE
          force_off X86_PKG_TEMP_THERMAL
          force_off INTEL_TCC
          force_off X86_INTEL_PSTATE

          # ACPI extras
          force_off ACPI_CPPC_LIB
          force_off ACPI_HOTPLUG_CPU
          force_off ACPI_CONTAINER
          force_off ACPI_HOTPLUG_IOAPIC
          force_off ACPI_TABLE_UPGRADE
          force_off ACPI_PRMT
          force_off ACPI_PCC
          force_off ACPI_LPIT
          force_off ACPI_AC
          force_off ACPI_BATTERY
          force_off ACPI_FAN
          force_off ACPI_SLEEP
          force_off MAILBOX
          force_off PCC

          # PS/2 keyboard stack
          force_off SERIO
          force_off SERIO_I8042
          force_off SERIO_LIBPS2
          force_off SERIO_SERPORT
          force_off KEYBOARD_ATKBD
          force_off INPUT_VIVALDIFMAP

          # SCSI
          force_off SCSI
          force_off SCSI_MOD

          # PNP
          force_off PNP
          force_off PNPACPI
          force_off PNP_DEBUG_MESSAGES

          # Thermal framework
          force_off THERMAL
          force_off THERMAL_GOV_STEP_WISE
          force_off THERMAL_GOV_USER_SPACE
          force_off PINCTRL

          # Misc bloat
          force_off VGA_ARB
          force_off VGA_CONSOLE
          force_off FONT_8x8
          force_off ALLOW_DEV_COREDUMP
          force_off FW_LOADER
          force_off VM_EVENT_COUNTERS
          force_off HOTPLUG_CPU
          force_off HOTPLUG_SMT
          force_off HOTPLUG_CORE_SYNC
          force_off HOTPLUG_SPLIT_STARTUP
          force_off HOTPLUG_PARALLEL
          force_off EFI_ESRT
          force_off EDAC_SUPPORT
          force_off CPU_ISOLATION
          force_off CONTEXT_TRACKING
          force_off CONTEXT_TRACKING_IDLE
          force_off X86_16BIT
          force_off X86_VSYSCALL_EMULATION
          force_off LEGACY_VSYSCALL_XONLY
          force_off X86_5LEVEL
          force_off SCHED_MC_PRIO
          force_off RANDOMIZE_KSTACK_OFFSET
          force_off CLOCKSOURCE_WATCHDOG
          force_off RTC_LIB
          force_off RTC_MC146818_LIB
          force_off GENERIC_CPU_VULNERABILITIES
          force_off FIRMWARE_MEMMAP
          force_off DMI_SCAN_MACHINE_NON_EFI_FALLBACK
          force_off PCI_LABEL
          force_off PCI_LOCKLESS_CONFIG
          force_off PCI_QUIRKS
          force_off X86_ESPFIX64
          force_off PCSPKR_PLATFORM
          force_off ISA_DMA_API
          force_off GENERIC_ISA_DMA
          force_off XZ_DEC_POWERPC
          force_off XZ_DEC_IA64
          force_off XZ_DEC_ARM
          force_off XZ_DEC_ARMTHUMB
          force_off XZ_DEC_SPARC
          force_off CRYPTO_LIB_BLAKE2S_GENERIC
          force_off SHMEM
          force_off LOG_CPU_MAX_BUF_SHIFT

          # Intel-specific code on AMD machine
          force_off CPU_SUP_INTEL
          force_off X86_CPU_RESCTRL
          force_off PERF_EVENTS_AMD_POWER
          force_off X86_MCE_INTEL

          # Crypto self-tests and blake2s (nothing needs this)
          force_off CRYPTO_MANAGER_DISABLE_TESTS
          force_off CRYPTO_BLAKE2S
          force_off CRYPTO_LIB_BLAKE2S
          force_off CRYPTO_LIB_BLAKE2S_GENERIC
          force_off CRYPTO_SELFTESTS

          # DMI quirk tables (massive, mostly for obscure hardware)
          force_off DMI_SCAN_MACHINE_NON_EFI_FALLBACK
          force_off ACPI_CUSTOM_DSDT

          # PCI quirks table
          force_off PCI_QUIRKS

          # Coredump still sneaking in
          force_off COREDUMP
          force_off ELF_CORE
          force_off ELFCORE
          force_off CORE_DUMP_DEFAULT_ELF_HEADERS

          # DRM panel orientation still compiled in via FB path
          force_off DRM_PANEL_ORIENTATION_QUIRKS

          # BTS (branch tracing, debug feature)
          force_off X86_BTS

          # CPU vulnerability mitigations reporting (not needed for shell)
          force_off GENERIC_CPU_VULNERABILITIES
          force_off CPU_MITIGATIONS

          echo "=== Force-off complete ==="

      - name: Show config summary
        run: |
          cd linux-6.6
          echo "=== Total options enabled ==="
          grep "^CONFIG_" .config | wc -l

      - name: Build kernel
        run: |
          cd linux-6.6
          make -j$(nproc) bzImage 2>&1 | tail -30

      - name: Bloat report
        run: |
          cd linux-6.6
          echo "=== Top 60 largest symbols ==="
          nm --size-sort -r vmlinux | awk '{print $1, $3}' | head -60
          echo "=== Section sizes ==="
          size vmlinux

      - name: Report size
        run: |
          ls -lh linux-6.6/arch/x86/boot/bzImage
          du -k linux-6.6/arch/x86/boot/bzImage | awk '{print "Size: "$1" KB"}'

      - name: Upload vmlinuz
        uses: actions/upload-artifact@v4
        with:
          name: vmlinuz
          path: linux-6.6/arch/x86/boot/bzImage
          retention-days: 30
